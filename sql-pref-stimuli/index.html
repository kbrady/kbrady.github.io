<!DOCTYPE html>
<html lang="en">
<head>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

<!-- Custom css-->
<link rel="stylesheet" href="main.css">

<!--- Custom JS-->
<script src='sql.js'></script>
<script>
  //Create the database
  var db = new SQL.Database();

  function LoadFile() {
    // get the create statement
    var dataFrame = document.getElementById("db_create_statement");
    var create_statement = dataFrame.contentWindow.document.body.childNodes[0].innerHTML;
    // Run a query without reading the results
    db.run(create_statement);
  }

  function QueryException(message) {
    this.message = message;
    this.name = 'QueryException';
  }

  function RunQuery() {
    // get query
    var query = document.getElementById('query').value;
    // clear previous results
    var container = document.getElementById('results');
    for (i=0; i < container.childNodes.length; i++) {
      container.removeChild(container.childNodes[i]);
    }
    // return results
    try {
      query = query.trim()
      if (query[query.length-1] != ';') {
        throw new QueryException('You need to end your command with a semicolon (;) so the computer knows it is over.');
      }
      var results = db.exec(query);
      results.forEach(buildTable);
    } catch (e) {
      showWarning(e);
    }
  }

  function showWarning(error) {
    var err_text = improveMessage(error.message);
    // get the element we will put the results in
    var container = document.getElementById('results');
    // make an object to put the error message in
    var div = document.createElement('div');
    div.className = "alert alert-warning"
    div.appendChild(document.createTextNode(err_text));
    container.appendChild(div);
  }

  function improveMessage(err_text) {
    if (err_text.indexOf(": syntax error") != -1) {
      var query = err_text.substring("near ".length, err_text.indexOf(": syntax error"));
      return "There is an error in your SQL query near " + query + ".";
    }
    if (err_text.indexOf("no such table: ") != -1) {
      var table_name = err_text.substring("no such table: ".length, err_text.length);
      return "You have mistyped the name of the table as '" + table_name + "'. It should be 'participants'";
    }
    if (err_text.indexOf("no such column: ") != -1) {
      var col_name = err_text.substring("no such column: ".length, err_text.length);
      return "You have mistyped a column name as '" + col_name + "'. Did you mean id, maximum_shock, age or experimenter?";
    }
    if (err_text.indexOf("no such function: ") != -1) {
      var fun_name = err_text.substring("no such function: ".length, err_text.length);
      return fun_name + " is not a valid SQL aggregation function. Did you mean COUNT, MAX, MIN or AVG?";
    }
    return err_text;
  }

  function buildTable(result) {
    // get the element we will put the results in
    var container = document.getElementById('results');
    // make an object to built the table
    var table = document.createElement('table');
    table.className = "table table-bordered table-sm table-striped";
    var thead = document.createElement('thead');
    var tbody = document.createElement('tbody');
    // get the values from the result
    columns = result['columns'];
    values = result['values'];
    // add the columns to the table
    var header_row = document.createElement('tr');
    columns.forEach(
      function(c) {
        var th = document.createElement('th');
        th.appendChild(document.createTextNode(c));
        header_row.appendChild(th);
      }
    );
    thead.appendChild(header_row);
    table.appendChild(thead);
    // add the data one row at a time
    values.forEach(
      function(row) {
        var tr = document.createElement('tr');
        row.forEach(
          function(v) {
            var td = document.createElement('td');
            td.appendChild(document.createTextNode(v));
            tr.appendChild(td);
          }
        );
        tbody.appendChild(tr);
      }
    );
    table.appendChild(tbody);
    container.appendChild(table);
  }
</script>

<!--- Viewport stuff -->
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<!--- body of document -->
<body>
<!--- Title -->
<div class="page-header container">
  <h1>SQL Preference Study</h1>
</div>
<div class="container" id="content">
<div class="row">
<!--- Lesson side -->
<iframe id="lesson" class="col" src="instructions-1.html"></iframe>
<!--- SQL side -->
<div class="col">

<iframe id="db_create_statement" src="create_db.txt" onload="LoadFile();" style="display: none;">
</iframe>

<div class="container">
<div class="page-header">
  <h2>SQL Interpreter</h2>
</div>
Command:
<br/>
<textarea id="query"></textarea>
<br/>
<button type="button" class="btn btn-primary" onclick="RunQuery();">Run Command</button>
</div>

<div id="results" class="container">
</div>

</div>


</div>

</div>
</body>
</html>
